<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bot Message Dashboard</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom scrollbar styles */
    .overflow-y-auto::-webkit-scrollbar {
      width: 8px;
    }

    .overflow-y-auto::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .overflow-y-auto::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }

    .overflow-y-auto::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <section class="bg-white shadow-md rounded-lg p-4 flex flex-col h-[80vh]">
      <h2 class="text-xl font-semibold text-green-600 mb-4 flex items-center gap-2">
        <svg viewBox="0 0 377.764 377.764" class="h-6 w-6 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="#000000"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path fill-rule="evenodd" clip-rule="evenodd" fill="#3ACE01" d="M77.315 0h223.133c42.523 0 77.315 34.792 77.315 77.315v223.133c0 42.523-34.792 77.315-77.315 77.315H77.315C34.792 377.764 0 342.972 0 300.448V77.315C0 34.792 34.792 0 77.315 0z"></path><path fill-rule="evenodd" clip-rule="evenodd" fill="#FFF" d="M188.515 62.576c76.543 0 138.593 49.687 138.593 110.979 0 21.409-7.576 41.398-20.691 58.351-.649.965-1.497 2.031-2.566 3.209l-.081.088c-4.48 5.36-9.525 10.392-15.072 15.037-38.326 35.425-101.41 77.601-109.736 71.094-7.238-5.656 11.921-33.321-10.183-37.925-1.542-.177-3.08-.367-4.605-.583l-.029-.002v-.002c-64.921-9.223-114.222-54.634-114.222-109.267-.002-61.292 62.049-110.979 138.592-110.979z"></path><path fill-rule="evenodd" clip-rule="evenodd" fill="#3ACE01" d="M108.103 208.954h27.952c3.976 0 7.228-3.253 7.228-7.229v-.603c0-3.976-3.252-7.228-7.228-7.228h-20.121v-45.779c0-3.976-3.252-7.228-7.228-7.228h-.603c-3.976 0-7.228 3.252-7.228 7.228v53.609c0 3.977 3.252 7.23 7.228 7.23zm173.205-33.603v-.603c0-3.976-3.253-7.228-7.229-7.228h-20.12v-11.445h20.12c3.976 0 7.229-3.252 7.229-7.228v-.603c0-3.976-3.253-7.228-7.229-7.228h-27.952c-3.976 0-7.228 3.252-7.228 7.228v53.609c0 3.976 3.252 7.229 7.228 7.229h27.952c3.976 0 7.229-3.253 7.229-7.229v-.603c0-3.976-3.253-7.228-7.229-7.228h-20.12v-11.445h20.12c3.976.002 7.229-3.251 7.229-7.226zm-53.755 31.448l.002-.003a7.207 7.207 0 0 0 2.09-5.07v-53.609c0-3.976-3.252-7.228-7.229-7.228h-.603c-3.976 0-7.228 3.252-7.228 7.228v31.469l-26.126-35.042c-1.248-2.179-3.598-3.655-6.276-3.655h-.603c-3.976 0-7.229 3.252-7.229 7.228v53.609c0 3.976 3.252 7.229 7.229 7.229h.603c3.976 0 7.228-3.253 7.228-7.229v-32.058l26.314 35.941c.162.252.339.494.53.724l.001.002c.723.986 1.712 1.662 2.814 2.075.847.35 1.773.544 2.742.544h.603a7.162 7.162 0 0 0 3.377-.844c.723-.344 1.332-.788 1.761-1.311zm-71.208 2.155h.603c3.976 0 7.228-3.253 7.228-7.229v-53.609c0-3.976-3.252-7.228-7.228-7.228h-.603c-3.976 0-7.229 3.252-7.229 7.228v53.609c0 3.976 3.253 7.229 7.229 7.229z"></path></g></svg>
        LINE Messages
      </h2>
      <ul id="lineMessages" class="flex-1 overflow-y-auto space-y-4"></ul>
    </section>

    <section class="bg-white shadow-md rounded-lg p-4 flex flex-col h-[80vh]">
      <h2 class="text-xl font-semibold text-blue-600 mb-4 flex items-center gap-2">
        <svg viewBox="0 0 32 32" class="h-6 w-6 text-blue-500" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <circle cx="16" cy="16" r="14" fill="url(#paint0_linear_87_7225)"></circle> <path d="M22.9866 10.2088C23.1112 9.40332 22.3454 8.76755 21.6292 9.082L7.36482 15.3448C6.85123 15.5703 6.8888 16.3483 7.42147 16.5179L10.3631 17.4547C10.9246 17.6335 11.5325 17.541 12.0228 17.2023L18.655 12.6203C18.855 12.4821 19.073 12.7665 18.9021 12.9426L14.1281 17.8646C13.665 18.3421 13.7569 19.1512 14.314 19.5005L19.659 22.8523C20.2585 23.2282 21.0297 22.8506 21.1418 22.1261L22.9866 10.2088Z" fill="white"></path> <defs> <linearGradient id="paint0_linear_87_7225" x1="16" y1="2" x2="16" y2="30" gradientUnits="userSpaceOnUse"> <stop stop-color="#37BBFE"></stop> <stop offset="1" stop-color="#007DBB"></stop> </linearGradient> </defs> </g></svg>
        Telegram Messages
      </h2>
      <ul id="telegramMessages" class="flex-1 overflow-y-auto space-y-4"></ul>
    </section>

    <section class="bg-white shadow-md rounded-lg p-4 flex flex-col h-[80vh]">
      <h2 class="text-xl font-semibold text-indigo-600 mb-4 flex items-center gap-2">
        <svg viewBox="0 0 24 24" class="h-6 w-6 text-blue-500" id="meteor-icon-kit__regular-messanger" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path fill-rule="evenodd" clip-rule="evenodd" d="M0 11.6407C0 4.9526 5.23944 0.000488281 12 0.000488281C18.7606 0.000488281 24 4.9526 24 11.6407C24 18.3289 18.7606 23.281 12 23.281C10.7855 23.281 9.61932 23.1216 8.52555 22.8198C8.31308 22.7619 8.08853 22.7788 7.88571 22.8681L5.50503 23.9184C4.88209 24.1912 4.17948 23.7494 4.15775 23.0685L4.09256 20.9341C4.0829 20.6709 3.96459 20.427 3.76901 20.2508C1.43421 18.1623 0 15.1393 0 11.6407ZM8.32032 9.45321L4.79517 15.0452C4.45473 15.5812 5.1163 16.1872 5.62093 15.8033L9.40684 12.9301C9.66278 12.7369 10.0153 12.7345 10.2736 12.9277L13.0769 15.0307C13.9171 15.6609 15.1195 15.4387 15.6797 14.5502L19.2048 8.95823C19.5453 8.42222 18.8837 7.81618 18.3791 8.20009L14.5932 11.0733C14.3372 11.2665 13.9847 11.2689 13.7264 11.0757L10.9231 8.97272C10.0829 8.34254 8.88048 8.56467 8.32032 9.45321Z" fill="#085ee7"></path></g></svg>
        Messenger Messages
      </h2>
      <ul id="messengerMessages" class="flex-1 overflow-y-auto space-y-4"></ul>
    </section>

    <section class="bg-white shadow-md rounded-lg p-4 flex flex-col h-[80vh]">
      <h2 class="text-xl font-semibold text-purple-600 mb-4 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6 text-purple-500">
          <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
          <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
          <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
        </svg>
        Instagram Messages
      </h2>
      <ul id="instagramMessages" class="flex-1 overflow-y-auto space-y-4"></ul>
    </section>
  </div>

  <script>
    const socket = io();
    const lineList = document.getElementById('lineMessages');
    const telegramList = document.getElementById('telegramMessages');
    const messengerList = document.getElementById('messengerMessages');
    const instagramList = document.getElementById('instagramMessages'); // Get the new Instagram list

    // Store references to the message containers for each user
    const userMessageContainers = {
      line: {},
      telegram: {},
      facebook: {}, // Assuming 'facebook' is the platform key for Messenger
      instagram: {} // Added for Instagram
    };

    fetch('/messages')
      .then(res => res.json())
      .then(data => {
        if (!Array.isArray(data)) {
          console.error('Unexpected response:', data);
          return;
        }
        data.forEach(msg => renderMessage(msg, false)); // Pass false for initial load, don't scroll
      })
      .catch(error => console.error('Error fetching initial messages:', error));

    socket.on('new-message', (msg) => {
      renderMessage(msg, true); // Pass true for new messages, scroll to bottom
    });

    function renderMessage(data, shouldScroll) {
      const { user_id, message, platform } = data;
      let targetList;
      let userContainerMap;

      if (platform === 'line') {
        targetList = lineList;
        userContainerMap = userMessageContainers.line;
      } else if (platform === 'telegram') {
        targetList = telegramList;
        userContainerMap = userMessageContainers.telegram;
      } else if (platform === 'facebook') {
        targetList = messengerList;
        userContainerMap = userMessageContainers.facebook;
      } else if (platform === 'instagram') { // Handle Instagram messages
        targetList = instagramList;
        userContainerMap = userMessageContainers.instagram;
      } else {
        console.warn('Unknown platform:', platform);
        return;
      }

      let userEntry = userContainerMap[user_id];

      if (!userEntry) {
        // Create a new entry for this user
        userEntry = document.createElement('li');
        userEntry.className = "bg-white p-3 rounded shadow-md border border-gray-200"; // Added border for better separation
        userEntry.id = `${platform}-${user_id}`; // Unique ID for direct access

        userEntry.innerHTML = `
          <div class="flex items-center gap-2 mb-2">
            <span class="font-bold text-md text-gray-800">${user_id}</span>
            <span class="text-xs text-gray-500">(${platform.charAt(0).toUpperCase() + platform.slice(1)} User)</span>
          </div>
          <div class="messages-list space-y-1 text-gray-700 max-h-40 overflow-y-auto pr-2">
            </div>
          <div class="flex items-center gap-2 mt-4">
            <input type="text" placeholder="Reply to ${user_id}..." class="flex-1 border rounded px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-400" />
            <button class="send-button bg-blue-500 text-white text-sm px-3 py-1 rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">Send</button>
          </div>
        `;
        targetList.appendChild(userEntry);
        userContainerMap[user_id] = userEntry;

        // Attach event listener for the send button
        const input = userEntry.querySelector('input');
        const button = userEntry.querySelector('.send-button');
        button.onclick = () => {
          const reply = input.value.trim();
          if (!reply) return;
          fetch('/reply', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reply, user_id: user_id, platform: platform }),
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json(); // Or .text() if the server doesn't send JSON
          })
          .then(data => {
            console.log('Reply sent successfully:', data);
          })
          .catch(error => {
            console.error('Error sending reply:', error);
          });
          input.value = '';
        };
      }

      // Append the new message to the user's message list
      const messagesListDiv = userEntry.querySelector('.messages-list');
      const messageElement = document.createElement('p');
      messageElement.className = "text-sm break-words"; // Added break-words for long messages
      messageElement.textContent = message;
      messagesListDiv.appendChild(messageElement);

      // Scroll to the bottom of the messages list if shouldScroll is true
      if (shouldScroll) {
        messagesListDiv.scrollTop = messagesListDiv.scrollHeight;
      }
    }
  </script>

</body>
</html>
